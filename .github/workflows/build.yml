name: C/C++ CI

on: [push]

jobs:

  build:
    strategy:
        matrix:
          cc: [gcc, clang]

    runs-on: ubuntu-latest
    steps:
      - name: Install deps
        run: |
          sudo add-apt-repository ppa:beineri/opt-qt-5.14.0-bionic
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends qt514-meta-minimal qt514base qt514serialport
      - uses: actions/checkout@master
      - name: Build
        run: |
          SRCDIR="$PWD"
          mkdir /tmp/_build /tmp/_install
          cd /tmp/_build
          source /opt/qt514/bin/qt514-env.sh
          export CC=${{ matrix.cc }}
          cmake -DCMAKE_INSTALL_PREFIX=/tmp/_install "$SRCDIR"
          make VERBOSE=1
          make install

  clang-format:
    runs-on: ubuntu-latest
    steps:
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends clang-format-6.0
      - uses: actions/checkout@master
      - name: clang-format
        run: |
          find "$PWD" \( -name '*.[ch]' -o -name '*.cpp' -o -name '*.cc' \) -exec clang-format -i {}
          git diff --exit-code
